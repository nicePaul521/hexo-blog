---
title: 面试必备之红黑树
author: paul yu
toc: true
categories:
- 找工作
- 面试
tags: 
- 红黑树
- 数据结构
---

# 写在前面

>   第一次接收到腾讯hr的电话面试时，被提问的第一个问题便是红黑树，当时没做好准备一脸懵逼，为了接下来的正式找工作，也应该对这个知识点更深刻的了解。

红黑树是一种比较难的数据结构，怎么自平衡？什么时候左旋和右旋？插入和删除后破坏了树的平衡后怎么处理？本文以图文的形式讲解红黑树的知识点。

# 正文

## 红黑树的定义和性质

红黑树是一种含有红黑结点并能自平衡的二叉查找树，它必须满足下面性质：

-   每个结点要么是黑色，要么是红色
-   根节点是黑色
-   每个叶子结点(NIL)是黑色
-   每个红色结点的两个子节点一定是黑色（从每个叶子到根的所有路径上不能有两个连续的红色结点）
-   任意一结点到每个叶子结点的路径都包含数量相同的黑结点
    -   如果某个结点存在黑子结点，那么该结点肯定有两个子节点

下图就是一个简单的红黑树。其中Nil为叶子结点，并且是黑色的。

![](http://image-paul-blogs.test.upcdn.net/shu/s01.webp)

红黑树并不是完美的平衡二叉树，从上图也可以看出，根节点P的左子树明显比右子树高，但左子树和右子树的黑节点的层数是相同的。也就是任意一个结点到叶子结点的路径都包含数量相同的黑节点。所以称红黑树的这种平衡为黑色完美平衡。

约定一下红黑树结点的叫法：

![](http://image-paul-blogs.test.upcdn.net/shu/s02.webp)

我们把当前正在处理（遍历）的结点称为当前结点。如上图中的D，它的父亲称为父节点，父亲的另外一个子节点叫兄弟结点。父亲的父亲叫祖父结点。

红黑树的自平衡，依靠三种操作：

-   **左旋**：以某个结点作为支点，其右子结点变为旋转结点的父节点，右子节点的左子节点变为旋转结点的右子结点，左子结点保持不变。
-   **右旋**：以某个结点为支点，其左子结点变为旋转结点的父节点，左子结点的右结点变为旋转结点的左子结点，右子结点保持不变。
-   **变色**：结点的颜色由红变黑或由黑变红。

![](http://image-paul-blogs.test.upcdn.net/shu/s03.webp)

![](http://image-paul-blogs.test.upcdn.net/shu/s04.webp)

上面所说的旋转结点也即旋转的支点，图4和图5中的P结n点。

先忽略颜色，可以看到旋转操作不会影响旋转结点的父节点，父节点以上的结构还是保持不变。

`左旋`只是影响旋转结点和其**右子树**的结构，把右子树中的结点往左子树挪动

`右旋`只是影响旋转结点和其**左子树**结构，把左子树的结点往右子树挪动。

所以旋转操作是**局部**的，另外看出旋转能使红黑树保持平衡的端详了：当一边子树的结点少了，会向另外一边子树借一些结点，反之亦然。

要保持红黑树的性质，结点挪动后还需要进行变色。因此**红黑树总是能通过旋转和变色达到自平衡。**

## 红黑树查找

因为红黑树是一颗二叉平衡树，并且查找不会破坏树的平衡，所以查找跟平衡二叉树的查找无异。

1.  从根节点开始查找，把根节点设为当前结点。
2.  若当前结点为空，则返回null。
3.  若当前结点不为空，则用当前结点的key跟查找的key做比较
4.  若当前结点key等于查找key，那么该key就是查找目标，返回该节点
5.  若当前结点key大于查找key，把当前结点的左子节点设置为当前结点，重复步骤2
6.  若当前结点key小于查找key，把当前结点的右子结点设置为当前结点，重复步骤2

![](http://image-paul-blogs.test.upcdn.net/shu/s05.webp)

由于红黑树保持黑色完美平衡，`所以它的查找时间复杂度最坏为`$o(\log_2^{n})$.能有这么好的查找效率得益于红黑树的**自平衡特性**。而这背后的付出，红黑树的插入操作功不可没。

## 红黑树的插入

插入操作包括两部分：查找插入的位置；插入后的自平衡。查找插入的父节点，跟查找操作区别不大：

1.  从根节点开始查找
2.  若根节点为空，那么插入结点作为根节点，结束
3.  若根节点不为空，那么把根节点作为当前结点
4.  若当前结点为null，返回当前结点父节点，结束
5.  若当前key等于查找key，那么该key所在的结点就是插入结点，更新结点的值，结束。
6.  若当前结点key大于查找key，把当前结点的左子结点设置为当前结点，重复步骤4
7.  若当前结点key小于查找key，把当前结点的右子结点设置为当前结点，重复步骤4

![](http://image-paul-blogs.test.upcdn.net/shu/s06.webp)

插入位置找到后，把结点放在正确位置就行了。默认插入结点的颜色是红色的。所有插入的情景如图所示：

![](http://image-paul-blogs.test.upcdn.net/shu/s07.webp)

情景1，2，3的处理很简单，而情景4.2和4.3只是方向反转了而已。另外根据二叉树的性质，除了情景2，所有的插入操作都是在叶子结点进行的。因为在查找插入位置时，我们就是在找子节点为空的父节点的。

先约定一下插入结点的名称：

![](http://image-paul-blogs.test.upcdn.net/shu/s08.webp)

### 情景1：红黑树为空树

红黑树的性质之一：根节点是黑色，因此插入结点作为根节点，颜色设为黑色。

### 情景2：插入结点的key已存在

插入结点的key已存在，既然红黑树总保持平衡，在插入前红黑树就已经是平衡的，那么把插入结点设置为将要替代的结点的颜色，再把节点值更新就完成了插入。

### 情景3：插入结点的父节点为黑结点

由于插入的结点是红色的，当插入父节点为黑色时，并不会影响红黑树的平衡，直接插入即可，无需做自平衡。

### 情景4：插入节点的父节点为红结点

回想红黑树的性质：根节点是黑色，**如果插入的父节点为红结点，那么父节点不可能为根节点，所以插入节点总是存在祖父结点**。这点很重要，因为后续的选择操作肯定需要祖父结点的参与。

情景4又可分为很多的子情景。

#### 情景4.1：叔叔结点存在并且为红结点

从红黑树的性质：从叶子到根不能有两个连续的红色结点。因此祖父结点肯定为黑节点，那么此时插入子树的红黑层数就是：黑红红。显然最简单的处理方式就是把其改为：红黑红。下图所示：

处理：

-   将P和S设置为黑色
-   将PP设置为红色
-   将PP设置为插入结点

![](http://image-paul-blogs.test.upcdn.net/shu/s09.webp)

![](http://image-paul-blogs.test.upcdn.net/shu/s10.webp)

可以看到，我们把PP结点设为红色了，如果PP的父节点是黑色，那么无需任何处理；但如果PP的父节点是红色，此时红黑树不再平衡，所以需要把PP当作新的插入结点，继续做插入操作自平衡处理，直到平衡为止。

试想下PP刚好为根节点，那么必须把PP重新设为黑色，那么树的红黑结构变为：黑黑红。换句话说，从根到叶子结点的路径中，黑色结点增加了。这也是唯一一种会增加红黑树黑色结点层数的插入情景。

可以总结出：红黑树的生长是`自底向上`的。不同于普通的二叉查找，普通的二叉查找是`自顶向下`生长的。

#### 情景4.2：叔叔结点不存在或为黑节点，并且插入结点的父节点是祖父结点的左子结点

单纯从插入前来看，也即不算情景4.1自底向上处理时的情况，叔叔结点非红即为叶子结点。因为叔叔结点为黑节点，而父节点为红结点，那么叔叔所在子树的黑色结点就比父节点所在的子树多了，这还不满足红黑树的性质5.

前文说过，需要旋转操作时，肯定一边子树的结点多了或少了，需要租借给另一边。插入显然是多的情况，那么把多的结点租给另一边子树就可以了。

##### 情景4.2.1：插入结点是其父节点的左子结点

处理：

-   将P设为黑色
-   将PP设为红色
-   对PP进行左旋

![](http://image-paul-blogs.test.upcdn.net/shu/s11.webp)

由上图可得，左边两个红结点，右边不存在，那么一边一个刚刚好，并且因为红色，肯定不会破坏树的平衡。

当然也可以把P设为红色，把I和PP设为黑色，但把P设为红色，显然会出现情景4.1的情况，需要自底向上处理，做多了无谓的操作。

##### 情景4.2.2：插入结点是父节点的右子结点

这种情景显然可以转换为情景4.2.1，不做过多说明。

处理：

-   对P进行左旋
-   把P设置为插入结点，得到情景4.2.1
-   进行情景4.2.1的处理

![](http://image-paul-blogs.test.upcdn.net/shu/s12.webp)

#### 情景4.3：叔叔结点不存在或为黑节点，并且插入结点的父亲节点是祖父结点的右子结点

该情景对应情景4.2，只是方向反转，不做过多说明

##### 情景4.3.1：插入结点时其父节点的右子结点

处理：

-   将P设为黑色
-   将PP设为红色
-   对PP进行左旋

![](http://image-paul-blogs.test.upcdn.net/shu/s13.webp)

##### 情景4.3.2：插入结点是其父节点的左子结点

处理：

-   对P进行右旋
-   把P设置为插入结点，得到情景4.3.1
-   进行情景4.3.1的处理

![](http://image-paul-blogs.test.upcdn.net/shu/s14.webp)

### 习题

请画出图中的插入自平衡处理过程

![](http://image-paul-blogs.test.upcdn.net/shu/s15.webp)

答案：

![](http://image-paul-blogs.test.upcdn.net/shu/s30.webp)